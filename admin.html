<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Admin — Alchemy of Things</title>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#faf9f7;--card:#fff;--text:#1a1a1a;--muted:#6b6b6b;--light:#999;--border:#e8e6e3;--ok:#4a7c59;--err:#c44536}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Jost',sans-serif;font-weight:300;background:var(--bg);color:var(--text);min-height:100vh}
        .container{max-width:600px;margin:0 auto;padding:2rem 1.5rem}
        .login{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80vh;text-align:center}
        .login h1{font-size:1.5rem;font-weight:300;margin-bottom:.5rem}
        .login p{color:var(--muted);margin-bottom:2rem}
        .btn{padding:1rem 2.5rem;border:1px solid var(--text);background:var(--text);color:var(--bg);font-family:inherit;cursor:pointer}
        .btn:hover{background:transparent;color:var(--text)}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
        .header h1{font-size:1.25rem;font-weight:400}
        .logout{padding:.5rem 1rem;border:1px solid var(--border);background:0 0;font-family:inherit;font-size:.8rem;color:var(--muted);cursor:pointer}
        .logout:hover{border-color:var(--text);color:var(--text)}
        .tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:2rem}
        .tab{padding:1rem 1.5rem;border:none;background:0 0;font-family:inherit;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px}
        .tab:hover{color:var(--text)}
        .tab.active{color:var(--text);border-bottom-color:var(--text)}
        .hidden{display:none!important}
        .field{margin-bottom:1.5rem}
        .field label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:.5rem}
        .field input,.field textarea{width:100%;padding:.875rem;border:1px solid var(--border);background:var(--card);font-family:inherit;font-size:1rem}
        .field input:focus,.field textarea:focus{outline:0;border-color:var(--text)}
        .check{display:flex;align-items:center;gap:.75rem}
        .check input{width:1.25rem;height:1.25rem}
        .upload{border:2px dashed var(--border);padding:2rem;text-align:center;cursor:pointer;background:var(--card);position:relative}
        .upload:hover{border-color:var(--muted)}
        .upload.has{border-style:solid;padding:0}
        .upload input{position:absolute;inset:0;opacity:0;cursor:pointer}
        .upload img{width:100%;max-height:300px;object-fit:contain}
        .submit{width:100%;padding:1rem;margin-top:1rem}
        .msg{padding:1rem;margin-bottom:1.5rem;font-size:.9rem}
        .msg.ok{background:#f0f7f2;border:1px solid var(--ok);color:var(--ok)}
        .msg.err{background:#fdf4f3;border:1px solid var(--err);color:var(--err)}
        .list{margin-top:2rem}
        .list h3{font-size:.9rem;font-weight:400;color:var(--muted);margin-bottom:1rem}
        .item{display:flex;align-items:center;gap:1rem;padding:1rem;border:1px solid var(--border);margin-bottom:.5rem;background:var(--card)}
        .item img{width:60px;height:60px;object-fit:cover}
        .item-info{flex:1;min-width:0}
        .item-title{font-weight:400;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .item-meta{font-size:.8rem;color:var(--muted)}
        .item-actions{display:flex;gap:.5rem;margin-left:auto}
        .item-order{padding:.5rem .75rem;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;font-size:1rem}
        .item-order:hover:not(:disabled){background:var(--bg);border-color:var(--text)}
        .item-del{padding:.5rem;border:none;background:0 0;color:var(--light);cursor:pointer}
        .item-del:hover{color:var(--err)}
        .loading{display:flex;justify-content:center;padding:3rem}
        .loading::after{content:'';width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--text);border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .setup{max-width:500px;margin:0 auto;padding-top:4rem}
        .setup h2{font-size:1.25rem;font-weight:400;margin-bottom:1rem}
        .setup p{color:var(--muted);margin-bottom:1.5rem}
        .setup ol{margin:0 0 2rem 1.5rem;color:var(--muted)}
        .setup li{margin-bottom:.5rem}
        .setup code{background:var(--card);padding:.2rem .4rem;font-size:.85rem}
        .divider{margin:3rem 0;padding-top:2rem;border-top:1px solid var(--border)}
        .divider h3{font-size:1rem;font-weight:400;margin-bottom:1rem}
        @media(max-width:480px){.container{padding:1.5rem 1rem}.header{flex-direction:column;align-items:flex-start;gap:1rem}.tabs{overflow-x:auto}.tab{padding:1rem;white-space:nowrap}}
    </style>
</head>
<body>
    <div id="login" class="login">
        <h1>Alchemy of Things</h1>
        <p>Admin access required</p>
        <button class="btn" onclick="doLogin()">Enter</button>
    </div>

    <div id="setup" class="container hidden">
        <div class="setup">
            <h2>GitHub Setup</h2>
            <p>Connect to save artworks directly to your repository.</p>
            <ol>
                <li><a href="https://github.com/settings/tokens/new?scopes=repo&description=Alchemy" target="_blank">Create GitHub token</a></li>
                <li>Set expiration (90 days)</li>
                <li>Ensure <code>repo</code> is checked</li>
                <li>Copy token below</li>
            </ol>
            <div class="field"><label>GitHub Token</label><input type="password" id="gh-token" placeholder="ghp_xxxx"></div>
            <div class="field"><label>Repository</label><input type="text" id="gh-repo" value="TakuraChan/alchemy-of-things-gallery"></div>
            <button class="btn submit" onclick="saveConfig()">Save</button>
        </div>
    </div>

    <div id="admin" class="container hidden">
        <header class="header">
            <h1>Admin</h1>
            <div><span id="user"></span> <button class="logout" onclick="doLogout()">Logout</button></div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('paintings')">Paintings</button>
            <button class="tab" onclick="showTab('collections')">Collections</button>
            <button class="tab" onclick="showTab('photography')">Photography</button>
            <button class="tab" onclick="showTab('observations')">Observations</button>
            <button class="tab" onclick="showTab('content')">Content</button>
            <button class="tab" onclick="showTab('settings')">Settings</button>
        </div>

        <div id="msg" class="msg hidden"></div>

        <div id="paintings" class="tab-content">
            <form id="painting-form" onsubmit="return saveWork(event,'painting')">
                <input type="hidden" id="painting-edit-id">
                <input type="hidden" id="painting-edit-sha">
                <div class="field"><label>Image</label>
                    <div class="upload" id="painting-upload"><input type="file" accept="image/*" onchange="preview(this,'painting')"><span>Tap to upload</span></div>
                </div>
                <div class="field"><label>Title</label><input type="text" id="painting-title" required></div>
                <div class="field"><label>Collection</label><select id="painting-collection"><option value="">None</option></select></div>
                <div class="field"><label>Display Order</label><input type="number" id="painting-order" placeholder="1, 2, 3..." min="1"></div>
                <div class="field"><label>Year</label><input type="number" id="painting-year" value="2025"></div>
                <div class="field"><label>Medium</label><input type="text" id="painting-medium" value="Acrylic on canvas"></div>
                <div class="field"><label>Dimensions</label><input type="text" id="painting-dimensions" placeholder="60 × 80 cm"></div>
                <div class="field"><label>Price</label><input type="text" id="painting-price" placeholder="POA"></div>
                <div class="field"><label class="check"><input type="checkbox" id="painting-available" checked><span>Available</span></label></div>
                <button type="submit" class="btn submit" id="painting-btn">Add Painting</button>
            </form>
            <div class="list"><h3>Existing Works</h3><div id="painting-list"><div class="loading"></div></div></div>
        </div>

        <div id="photography" class="tab-content hidden">
            <p style="color:var(--muted);margin-bottom:1.5rem;font-size:.9rem">3-5 elevated photographs maximum.</p>
            <form id="photo-form" onsubmit="return saveWork(event,'photography')">
                <input type="hidden" id="photo-edit-id">
                <input type="hidden" id="photo-edit-sha">
                <div class="field"><label>Image</label>
                    <div class="upload" id="photo-upload"><input type="file" accept="image/*" onchange="preview(this,'photo')"><span>Tap to upload</span></div>
                </div>
                <div class="field"><label>Title</label><input type="text" id="photo-title" required></div>
                <div class="field"><label>Observation</label><select id="photo-collection"><option value="">None</option></select></div>
                <div class="field"><label>Display Order</label><input type="number" id="photo-order" placeholder="1, 2, 3..." min="1"></div>
                <div class="field"><label>Year</label><input type="number" id="photo-year" value="2025"></div>
                <div class="field"><label>Medium</label><input type="text" id="photo-medium" value="Archival pigment print"></div>
                <div class="field"><label>Dimensions</label><input type="text" id="photo-dimensions" placeholder="40 × 30 cm"></div>
                <div class="field"><label>Edition</label><input type="text" id="photo-edition" placeholder="Edition of 5"></div>
                <div class="field"><label class="check"><input type="checkbox" id="photo-available" checked><span>Available</span></label></div>
                <button type="submit" class="btn submit" id="photo-btn">Add Photograph</button>
            </form>
            <div class="list"><h3>Existing Works</h3><div id="photo-list"><div class="loading"></div></div></div>
        </div>

        <div id="collections" class="tab-content hidden">
            <p style="color:var(--muted);margin-bottom:1.5rem;font-size:.9rem">Organize paintings into collections. All active collections + next inactive are visible.</p>
            <form id="collection-form" onsubmit="return saveCollection(event,'collections')">
                <input type="hidden" id="collection-edit-id">
                <div class="field"><label>Name</label><input type="text" id="collection-name" placeholder="Collection 1" required></div>
                <div class="field"><label class="check"><input type="checkbox" id="collection-active"><span>Active (currently showing)</span></label></div>
                <button type="submit" class="btn submit" id="collection-btn">Add Collection</button>
            </form>
            <div class="list"><h3>Existing Collections</h3><div id="collection-list"><div class="loading"></div></div></div>
        </div>

        <div id="observations" class="tab-content hidden">
            <p style="color:var(--muted);margin-bottom:1.5rem;font-size:.9rem">Organize photographs into observations. All active observations + next inactive are visible.</p>
            <form id="observation-form" onsubmit="return saveCollection(event,'observations')">
                <input type="hidden" id="observation-edit-id">
                <div class="field"><label>Name</label><input type="text" id="observation-name" placeholder="Observation 1" required></div>
                <div class="field"><label class="check"><input type="checkbox" id="observation-active"><span>Active (currently showing)</span></label></div>
                <button type="submit" class="btn submit" id="observation-btn">Add Observation</button>
            </form>
            <div class="list"><h3>Existing Observations</h3><div id="observation-list"><div class="loading"></div></div></div>
        </div>

        <div id="content" class="tab-content hidden">
            <form onsubmit="return saveContent(event)">
                <h3 style="font-size:1rem;font-weight:400;margin-bottom:1.5rem">About Page</h3>
                <div class="field"><label>Name</label><input type="text" id="content-name" placeholder="Your name"></div>
                <div class="field"><label>Line 1</label><input type="text" id="content-line1" placeholder="e.g. Architect. Johannesburg."></div>
                <div class="field"><label>Line 2</label><input type="text" id="content-line2" placeholder="e.g. Work may be viewed by arrangement."></div>

                <div class="divider">
                    <h3>Photography Page</h3>
                    <div class="field"><label>Description</label><input type="text" id="content-photo-desc" placeholder="Short description for photography section"></div>
                </div>

                <div class="divider">
                    <h3>Contact</h3>
                    <div class="field"><label>Email Address</label><input type="email" id="content-email" placeholder="your@email.com"></div>
                </div>

                <button type="submit" class="btn submit">Save Content</button>
            </form>
        </div>

        <div id="settings" class="tab-content hidden">
            <form onsubmit="return saveSymbol(event)">
                <div class="field"><label>Symbol</label>
                    <div class="upload" id="symbol-upload"><input type="file" accept="image/svg+xml,image/png" onchange="preview(this,'symbol')"><span>Upload SVG</span></div>
                </div>
                <button type="submit" class="btn submit">Update Symbol</button>
            </form>
            <div class="divider">
                <h3>GitHub</h3>
                <div class="field"><label>Repository</label><input type="text" id="cfg-repo" readonly></div>
                <button class="logout" onclick="resetConfig()">Reset Config</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script>
const AUTH0={domain:'dev-0or17tvlovkdkwt6.us.auth0.com',clientId:'Wawyj8DhMBc4OevEU5tB6Q4dqmEjQ3i8',authorizationParams:{redirect_uri:location.origin+'/admin/'}};
let auth0,user,cfg,img={painting:null,photo:null,symbol:null};

async function init(){
    auth0=await window.auth0.createAuth0Client(AUTH0);
    if(location.search.includes('code=')){await auth0.handleRedirectCallback();history.replaceState({},'','/admin/')}
    if(await auth0.isAuthenticated()){user=await auth0.getUser();route()}else{show('login')}
}

function route(){
    cfg=JSON.parse(localStorage.getItem('alchemy_cfg'));
    if(!cfg||!cfg.token){show('setup')}
    else{show('admin');document.getElementById('user').textContent=user.email;document.getElementById('cfg-repo').value=cfg.repo;loadAll()}
}

function show(id){['login','setup','admin'].forEach(x=>document.getElementById(x).classList.toggle('hidden',x!==id))}

async function doLogin(){await auth0.loginWithRedirect()}
async function doLogout(){await auth0.logout({logoutParams:{returnTo:location.origin}})}

function saveConfig(){
    const t=document.getElementById('gh-token').value.trim(),r=document.getElementById('gh-repo').value.trim();
    if(!t||!r)return alert('Fill both fields');
    cfg={token:t,repo:r};localStorage.setItem('alchemy_cfg',JSON.stringify(cfg));route();
}

function resetConfig(){if(confirm('Reset?')){localStorage.removeItem('alchemy_cfg');cfg=null;route()}}

function showTab(t){
    document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active',x.textContent.toLowerCase().includes(t)));
    document.querySelectorAll('.tab-content').forEach(x=>x.classList.add('hidden'));
    document.getElementById(t).classList.remove('hidden');
}

function preview(input,type){
    const f=input.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=e=>{
        const c=document.getElementById(type+'-upload');
        c.classList.add('has');
        c.innerHTML='<input type="file" accept="image/*" onchange="preview(this,\''+type+'\')"><img src="'+e.target.result+'">';
        img[type]={data:e.target.result.split(',')[1],type:f.type};
    };
    r.readAsDataURL(f);
}

async function gh(path,method,body){
    const res=await fetch('https://api.github.com/repos/'+cfg.repo+path,{
        method:method||'GET',
        headers:{Authorization:'token '+cfg.token,Accept:'application/vnd.github.v3+json','Content-Type':'application/json'},
        body:body?JSON.stringify(body):undefined
    });
    if(!res.ok&&res.status!==404)throw new Error('GitHub error');
    return res;
}

function utf8_to_b64(str){return btoa(unescape(encodeURIComponent(str)))}
function b64_to_utf8(str){return decodeURIComponent(escape(atob(str)))}

async function getFile(p){try{const r=await gh('/contents/'+p);return r.status===404?null:await r.json()}catch{return null}}

async function saveFile(p,content,msg){
    const e=await getFile(p);
    await gh('/contents/'+p,'PUT',{message:msg,content:utf8_to_b64(content),sha:e?.sha,branch:'main'});
}

async function uploadImg(data,folder){
    const ext=data.type.split('/')[1]||'jpg',name=Date.now()+'.'+ext,path='images/'+folder+'/'+name;
    await gh('/contents/'+path,'PUT',{message:'Add '+name,content:data.data,branch:'main'});
    return '/'+path;
}

async function loadAll(){
    await Promise.all([
        loadList('paintings','painting-list'),
        loadList('photography','photo-list'),
        loadCollectionsList('collections','collection-list'),
        loadCollectionsList('observations','observation-list'),
        loadContent()
    ]);
    await populateCollectionDropdowns();
}

async function loadList(folder,containerId){
    const c=document.getElementById(containerId);c.innerHTML='<div class="loading"></div>';
    try{
        const r=await gh('/contents/data/'+folder);
        if(r.status===404){c.innerHTML='<p style="color:var(--muted)">No works yet.</p>';return}
        const files=await r.json();
        if(!files.length){c.innerHTML='<p style="color:var(--muted)">No works yet.</p>';return}

        // Load collections/observations for lookup
        const collectionFile=folder==='paintings'?'collections.json':'observations.json';
        let collectionMap={};
        try{
            const cr=await gh('/contents/data/'+collectionFile);
            if(cr.status!==404){
                const cfd=await cr.json();
                const collections=JSON.parse(b64_to_utf8(cfd.content));
                collections.forEach(col=>collectionMap[col.id]=col.name);
            }
        }catch{}

        // Load all works
        const works=[];
        for(const f of files){
            if(!f.name.endsWith('.json'))continue;
            const fr=await gh('/contents/data/'+folder+'/'+f.name),fd=await fr.json(),w=JSON.parse(b64_to_utf8(fd.content));
            works.push({...w,filename:f.name,sha:fd.sha});
        }

        // Sort by order
        works.sort((a,b)=>(a.order||999)-(b.order||999)||b.year-a.year);

        c.innerHTML='';
        works.forEach((w,i)=>{
            const collectionName=w.collectionId&&collectionMap[w.collectionId]?collectionMap[w.collectionId]:'No collection';
            c.innerHTML+=`<div class="item">
                <img src="${w.image}" onerror="this.style.background='var(--border)'">
                <div class="item-info">
                    <div class="item-title">${w.title}</div>
                    <div class="item-meta">${w.year} · ${collectionName} · ${w.available?'Available':'Sold'}</div>
                </div>
                <div class="item-actions">
                    ${i>0?`<button class="item-order" onclick="moveWork('${folder}','${w.filename}',${w.order||999},-1)" title="Move up">↑</button>`:'<button class="item-order" disabled style="opacity:.3">↑</button>'}
                    ${i<works.length-1?`<button class="item-order" onclick="moveWork('${folder}','${w.filename}',${w.order||999},1)" title="Move down">↓</button>`:'<button class="item-order" disabled style="opacity:.3">↓</button>'}
                    <button class="item-del" onclick="editWork('${folder}','${w.filename}')">Edit</button>
                    <button class="item-del" onclick="delWork('${folder}','${w.filename}','${w.sha}')">Delete</button>
                </div>
            </div>`;
        });
    }catch{c.innerHTML='<p style="color:var(--err)">Error loading.</p>'}
}

async function moveWork(folder,filename,currentOrder,direction){
    try{
        // Get all works
        const r=await gh('/contents/data/'+folder);
        const files=await r.json();
        const works=[];
        for(const f of files){
            if(!f.name.endsWith('.json'))continue;
            const fr=await gh('/contents/data/'+folder+'/'+f.name),fd=await fr.json(),w=JSON.parse(b64_to_utf8(fd.content));
            works.push({...w,filename:f.name,sha:fd.sha});
        }
        works.sort((a,b)=>(a.order||999)-(b.order||999)||b.year-a.year);

        const idx=works.findIndex(w=>w.filename===filename);
        if(idx===-1)return;

        const targetIdx=idx+direction;
        if(targetIdx<0||targetIdx>=works.length)return;

        // Swap orders
        const work1=works[idx];
        const work2=works[targetIdx];
        const order1=work1.order||idx+1;
        const order2=work2.order||targetIdx+1;

        work1.order=order2;
        work2.order=order1;

        // Save both works
        const saveWork1={...work1};
        const saveWork2={...work2};
        delete saveWork1.filename;delete saveWork1.sha;
        delete saveWork2.filename;delete saveWork2.sha;

        await saveFile('data/'+folder+'/'+filename,JSON.stringify(saveWork1,null,2),'Update order',work1.sha);
        await saveFile('data/'+folder+'/'+work2.filename,JSON.stringify(saveWork2,null,2),'Update order',work2.sha);

        msg('Order updated','ok');
        setTimeout(()=>loadAll(),1000);
    }catch(err){msg('Error reordering','err')}
}

async function delWork(folder,file,sha){
    if(!confirm('Delete?'))return;
    try{await gh('/contents/data/'+folder+'/'+file,'DELETE',{message:'Delete',sha,branch:'main'});msg('Deleted','ok');loadAll()}
    catch{msg('Error','err')}
}

async function editWork(folder,filename){
    try{
        const fr=await gh('/contents/data/'+folder+'/'+filename);
        const fd=await fr.json();
        const w=JSON.parse(b64_to_utf8(fd.content));
        const prefix=folder==='paintings'?'painting':'photo';

        // Populate form
        document.getElementById(prefix+'-title').value=w.title;
        document.getElementById(prefix+'-collection').value=w.collectionId||'';
        document.getElementById(prefix+'-order').value=w.order||'';
        document.getElementById(prefix+'-year').value=w.year;
        document.getElementById(prefix+'-medium').value=w.medium;
        document.getElementById(prefix+'-dimensions').value=w.dimensions||'';
        document.getElementById(prefix+'-available').checked=w.available;
        document.getElementById(prefix+'-edit-id').value=filename;
        document.getElementById(prefix+'-edit-sha').value=fd.sha;

        if(folder==='paintings'){
            document.getElementById('painting-price').value=w.price||'';
        }else{
            document.getElementById('photo-edition').value=w.edition||'';
        }

        // Show image preview
        if(w.image){
            const u=document.getElementById(prefix+'-upload');
            u.classList.add('has');
            u.innerHTML='<input type="file" accept="image/*" onchange="preview(this,\''+prefix+'\')"><img src="'+w.image+'">';
        }

        // Change button text
        document.getElementById(prefix+'-btn').textContent='Update '+(folder==='paintings'?'Painting':'Photograph');

        // Switch to appropriate tab
        showTab(folder);

        // Scroll to top
        window.scrollTo(0,0);
    }catch(err){msg('Error loading work','err')}
}

async function saveWork(e,type){
    e.preventDefault();
    const prefix=type==='painting'?'painting':'photo',folder=type==='painting'?'paintings':'photography';
    const btn=document.getElementById(prefix+'-btn');btn.disabled=true;btn.textContent='Saving...';
    try{
        const editId=document.getElementById(prefix+'-edit-id').value;
        const editSha=document.getElementById(prefix+'-edit-sha').value;
        const isEdit=!!editId;

        // For new works, require image. For edits, image is optional
        if(!isEdit&&!img[prefix])throw new Error('Upload image');

        const title=document.getElementById(prefix+'-title').value.trim();
        if(!title)throw new Error('Enter title');
        const id=title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');

        let imgPath;
        if(img[prefix]){
            imgPath=await uploadImg(img[prefix],folder);
        }else if(isEdit){
            // Keep existing image
            const fr=await gh('/contents/data/'+folder+'/'+editId);
            const fd=await fr.json();
            const existingWork=JSON.parse(b64_to_utf8(fd.content));
            imgPath=existingWork.image;
        }

        const work={id,title,year:+document.getElementById(prefix+'-year').value,medium:document.getElementById(prefix+'-medium').value,dimensions:document.getElementById(prefix+'-dimensions').value,image:imgPath,available:document.getElementById(prefix+'-available').checked};
        const collectionVal=document.getElementById(prefix+'-collection').value;
        if(collectionVal)work.collectionId=collectionVal;
        const orderVal=document.getElementById(prefix+'-order').value;
        if(orderVal)work.order=+orderVal;
        if(type==='painting'){const p=document.getElementById('painting-price').value;if(p)work.price=p}
        if(type==='photography'){const ed=document.getElementById('photo-edition').value;if(ed)work.edition=ed}

        // If editing and filename changed, delete old file
        if(isEdit&&editId!==id+'.json'){
            await gh('/contents/data/'+folder+'/'+editId,'DELETE',{message:'Remove old',sha:editSha,branch:'main'});
        }

        await saveFile('data/'+folder+'/'+id+'.json',JSON.stringify(work,null,2),(isEdit?'Update ':'Add ')+title);
        msg(title+' saved','ok');
        document.getElementById(prefix+'-form').reset();
        document.getElementById(prefix+'-edit-id').value='';
        document.getElementById(prefix+'-edit-sha').value='';
        const u=document.getElementById(prefix+'-upload');u.classList.remove('has');u.innerHTML='<input type="file" accept="image/*" onchange="preview(this,\''+prefix+'\')"><span>Tap to upload</span>';
        img[prefix]=null;
        btn.textContent=type==='painting'?'Add Painting':'Add Photograph';
        setTimeout(()=>loadAll(),1000);
    }catch(err){msg(err.message||'Error','err')}
    btn.disabled=false;btn.textContent=type==='painting'?'Add Painting':'Add Photograph';
    return false;
}

async function saveSymbol(e){
    e.preventDefault();
    if(!img.symbol)return msg('Upload symbol','err');
    try{
        const ex=await getFile('images/symbol.svg');
        await gh('/contents/images/symbol.svg','PUT',{message:'Update symbol',content:img.symbol.data,sha:ex?.sha,branch:'main'});
        msg('Symbol updated','ok');img.symbol=null;
    }catch{msg('Error','err')}
    return false;
}

async function loadContent(){
    try{
        const r=await gh('/contents/data/content.json');
        if(r.status===404)return;
        const fd=await r.json();
        const content=JSON.parse(b64_to_utf8(fd.content));

        document.getElementById('content-name').value=content.about?.name||'';
        document.getElementById('content-line1').value=content.about?.line1||'';
        document.getElementById('content-line2').value=content.about?.line2||'';
        document.getElementById('content-photo-desc').value=content.photography?.description||'';
        document.getElementById('content-email').value=content.contact?.email||'';
    }catch{}
}

async function saveContent(e){
    e.preventDefault();
    try{
        const content={
            about:{
                name:document.getElementById('content-name').value.trim(),
                line1:document.getElementById('content-line1').value.trim(),
                line2:document.getElementById('content-line2').value.trim()
            },
            photography:{
                description:document.getElementById('content-photo-desc').value.trim()
            },
            contact:{
                email:document.getElementById('content-email').value.trim()
            }
        };

        await saveFile('data/content.json',JSON.stringify(content,null,2),'Update content');
        msg('Content saved','ok');
    }catch(err){msg('Error saving content','err')}
    return false;
}

async function loadCollectionsList(type,containerId){
    const c=document.getElementById(containerId);c.innerHTML='<div class="loading"></div>';
    const file=type+'.json';
    try{
        const r=await gh('/contents/data/'+file);
        if(r.status===404){c.innerHTML='<p style="color:var(--muted)">No '+type+' yet.</p>';return}
        const fd=await r.json();
        const collections=JSON.parse(b64_to_utf8(fd.content));
        if(!collections.length){c.innerHTML='<p style="color:var(--muted)">No '+type+' yet.</p>';return}

        collections.sort((a,b)=>a.order-b.order);

        c.innerHTML='';
        collections.forEach((col,i)=>{
            const label=type==='collections'?'Collection':'Observation';
            c.innerHTML+=`<div class="item">
                <div class="item-info">
                    <div class="item-title">${col.name}</div>
                    <div class="item-meta">Order: ${col.order} · ${col.active?'Active':'Inactive'}</div>
                </div>
                <div class="item-actions">
                    ${i>0?`<button class="item-order" onclick="moveCollection('${type}',${i},-1)" title="Move up">↑</button>`:'<button class="item-order" disabled style="opacity:.3">↑</button>'}
                    ${i<collections.length-1?`<button class="item-order" onclick="moveCollection('${type}',${i},1)" title="Move down">↓</button>`:'<button class="item-order" disabled style="opacity:.3">↓</button>'}
                    <button class="item-del" onclick="editCollection('${type}',${i})">Edit</button>
                    <button class="item-del" onclick="delCollection('${type}',${i})">Delete</button>
                </div>
            </div>`;
        });
    }catch{c.innerHTML='<p style="color:var(--err)">Error loading.</p>'}
}

async function saveCollection(e,type){
    e.preventDefault();
    const prefix=type==='collections'?'collection':'observation';
    const btn=document.getElementById(prefix+'-btn');btn.disabled=true;btn.textContent='Saving...';
    const file=type+'.json';
    try{
        const editIdx=document.getElementById(prefix+'-edit-id').value;
        const isEdit=editIdx!=='';

        // Load existing collections
        let collections=[];
        const r=await gh('/contents/data/'+file);
        if(r.status!==404){
            const fd=await r.json();
            collections=JSON.parse(b64_to_utf8(fd.content));
        }

        const name=document.getElementById(prefix+'-name').value.trim();
        if(!name)throw new Error('Enter name');
        const id=name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');

        const collection={
            id:isEdit?collections[+editIdx].id:id,
            name,
            order:isEdit?collections[+editIdx].order:collections.length+1,
            active:document.getElementById(prefix+'-active').checked
        };

        if(isEdit){
            collections[+editIdx]=collection;
        }else{
            collections.push(collection);
        }

        await saveFile('data/'+file,JSON.stringify(collections,null,2),(isEdit?'Update ':'Add ')+type);
        msg(name+' saved','ok');
        document.getElementById(prefix+'-form').reset();
        document.getElementById(prefix+'-edit-id').value='';
        btn.textContent=type==='collections'?'Add Collection':'Add Observation';
        setTimeout(()=>loadAll(),1000);
    }catch(err){msg(err.message||'Error','err')}
    btn.disabled=false;btn.textContent=type==='collections'?'Add Collection':'Add Observation';
    return false;
}

async function moveCollection(type,idx,direction){
    const file=type+'.json';
    try{
        const r=await gh('/contents/data/'+file);
        const fd=await r.json();
        const collections=JSON.parse(b64_to_utf8(fd.content));
        collections.sort((a,b)=>a.order-b.order);

        const targetIdx=idx+direction;
        if(targetIdx<0||targetIdx>=collections.length)return;

        // Swap orders
        const order1=collections[idx].order;
        const order2=collections[targetIdx].order;
        collections[idx].order=order2;
        collections[targetIdx].order=order1;

        await saveFile('data/'+file,JSON.stringify(collections,null,2),'Reorder '+type,fd.sha);
        msg('Order updated','ok');
        setTimeout(()=>loadAll(),1000);
    }catch{msg('Error reordering','err')}
}

async function editCollection(type,idx){
    try{
        const file=type+'.json';
        const r=await gh('/contents/data/'+file);
        const fd=await r.json();
        const collections=JSON.parse(b64_to_utf8(fd.content));
        collections.sort((a,b)=>a.order-b.order);

        const col=collections[idx];
        const prefix=type==='collections'?'collection':'observation';

        document.getElementById(prefix+'-name').value=col.name;
        document.getElementById(prefix+'-active').checked=col.active;
        document.getElementById(prefix+'-edit-id').value=idx;
        document.getElementById(prefix+'-btn').textContent='Update '+(type==='collections'?'Collection':'Observation');

        showTab(type);
        window.scrollTo(0,0);
    }catch{msg('Error loading','err')}
}

async function delCollection(type,idx){
    if(!confirm('Delete? Artworks will remain but lose collection assignment.'))return;
    const file=type+'.json';
    try{
        const r=await gh('/contents/data/'+file);
        const fd=await r.json();
        const collections=JSON.parse(b64_to_utf8(fd.content));
        collections.sort((a,b)=>a.order-b.order);
        collections.splice(idx,1);

        await saveFile('data/'+file,JSON.stringify(collections,null,2),'Delete '+type,fd.sha);
        msg('Deleted','ok');
        setTimeout(()=>loadAll(),1000);
    }catch{msg('Error','err')}
}

async function populateCollectionDropdowns(){
    // Populate painting collections
    try{
        const r=await gh('/contents/data/collections.json');
        const select=document.getElementById('painting-collection');
        if(r.status!==404){
            const fd=await r.json();
            const collections=JSON.parse(b64_to_utf8(fd.content));
            collections.sort((a,b)=>a.order-b.order);
            select.innerHTML='<option value="">None</option>'+collections.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
        }
    }catch{}

    // Populate photo observations
    try{
        const r=await gh('/contents/data/observations.json');
        const select=document.getElementById('photo-collection');
        if(r.status!==404){
            const fd=await r.json();
            const observations=JSON.parse(b64_to_utf8(fd.content));
            observations.sort((a,b)=>a.order-b.order);
            select.innerHTML='<option value="">None</option>'+observations.map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
        }
    }catch{}
}

function msg(t,type){const m=document.getElementById('msg');m.textContent=t;m.className='msg '+type;setTimeout(()=>m.classList.add('hidden'),4000)}

init();
    </script>
</body>
</html>
