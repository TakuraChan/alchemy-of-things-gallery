<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Admin — Alchemy of Things</title>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#faf9f7;--card:#fff;--text:#1a1a1a;--muted:#6b6b6b;--light:#999;--border:#e8e6e3;--ok:#4a7c59;--err:#c44536}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Jost',sans-serif;font-weight:300;background:var(--bg);color:var(--text);min-height:100vh}
        .container{max-width:600px;margin:0 auto;padding:2rem 1.5rem}
        .login{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80vh;text-align:center}
        .login h1{font-size:1.5rem;font-weight:300;margin-bottom:.5rem}
        .login p{color:var(--muted);margin-bottom:2rem}
        .btn{padding:1rem 2.5rem;border:1px solid var(--text);background:var(--text);color:var(--bg);font-family:inherit;cursor:pointer}
        .btn:hover{background:transparent;color:var(--text)}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
        .header h1{font-size:1.25rem;font-weight:400}
        .logout{padding:.5rem 1rem;border:1px solid var(--border);background:0 0;font-family:inherit;font-size:.8rem;color:var(--muted);cursor:pointer}
        .logout:hover{border-color:var(--text);color:var(--text)}
        .tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:2rem}
        .tab{padding:1rem 1.5rem;border:none;background:0 0;font-family:inherit;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px}
        .tab:hover{color:var(--text)}
        .tab.active{color:var(--text);border-bottom-color:var(--text)}
        .hidden{display:none!important}
        .field{margin-bottom:1.5rem}
        .field label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:.5rem}
        .field input,.field textarea{width:100%;padding:.875rem;border:1px solid var(--border);background:var(--card);font-family:inherit;font-size:1rem}
        .field input:focus,.field textarea:focus{outline:0;border-color:var(--text)}
        .check{display:flex;align-items:center;gap:.75rem}
        .check input{width:1.25rem;height:1.25rem}
        .upload{border:2px dashed var(--border);padding:2rem;text-align:center;cursor:pointer;background:var(--card);position:relative}
        .upload:hover{border-color:var(--muted)}
        .upload.has{border-style:solid;padding:0}
        .upload input{position:absolute;inset:0;opacity:0;cursor:pointer}
        .upload img{width:100%;max-height:300px;object-fit:contain}
        .submit{width:100%;padding:1rem;margin-top:1rem}
        .msg{padding:1rem;margin-bottom:1.5rem;font-size:.9rem}
        .msg.ok{background:#f0f7f2;border:1px solid var(--ok);color:var(--ok)}
        .msg.err{background:#fdf4f3;border:1px solid var(--err);color:var(--err)}
        .list{margin-top:2rem}
        .list h3{font-size:.9rem;font-weight:400;color:var(--muted);margin-bottom:1rem}
        .item{display:flex;align-items:center;gap:1rem;padding:1rem;border:1px solid var(--border);margin-bottom:.5rem;background:var(--card)}
        .item img{width:60px;height:60px;object-fit:cover}
        .item-info{flex:1;min-width:0}
        .item-title{font-weight:400;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .item-meta{font-size:.8rem;color:var(--muted)}
        .item-del{padding:.5rem;border:none;background:0 0;color:var(--light);cursor:pointer}
        .item-del:hover{color:var(--err)}
        .loading{display:flex;justify-content:center;padding:3rem}
        .loading::after{content:'';width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--text);border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .setup{max-width:500px;margin:0 auto;padding-top:4rem}
        .setup h2{font-size:1.25rem;font-weight:400;margin-bottom:1rem}
        .setup p{color:var(--muted);margin-bottom:1.5rem}
        .setup ol{margin:0 0 2rem 1.5rem;color:var(--muted)}
        .setup li{margin-bottom:.5rem}
        .setup code{background:var(--card);padding:.2rem .4rem;font-size:.85rem}
        .divider{margin:3rem 0;padding-top:2rem;border-top:1px solid var(--border)}
        .divider h3{font-size:1rem;font-weight:400;margin-bottom:1rem}
        @media(max-width:480px){.container{padding:1.5rem 1rem}.header{flex-direction:column;align-items:flex-start;gap:1rem}.tabs{overflow-x:auto}.tab{padding:1rem;white-space:nowrap}}
    </style>
</head>
<body>
    <div id="login" class="login">
        <h1>Alchemy of Things</h1>
        <p>Admin access required</p>
        <button class="btn" onclick="doLogin()">Enter</button>
    </div>

    <div id="setup" class="container hidden">
        <div class="setup">
            <h2>GitHub Setup</h2>
            <p>Connect to save artworks directly to your repository.</p>
            <ol>
                <li><a href="https://github.com/settings/tokens/new?scopes=repo&description=Alchemy" target="_blank">Create GitHub token</a></li>
                <li>Set expiration (90 days)</li>
                <li>Ensure <code>repo</code> is checked</li>
                <li>Copy token below</li>
            </ol>
            <div class="field"><label>GitHub Token</label><input type="password" id="gh-token" placeholder="ghp_xxxx"></div>
            <div class="field"><label>Repository</label><input type="text" id="gh-repo" value="TakuraChan/alchemy-of-things-gallery"></div>
            <button class="btn submit" onclick="saveConfig()">Save</button>
        </div>
    </div>

    <div id="admin" class="container hidden">
        <header class="header">
            <h1>Admin</h1>
            <div><span id="user"></span> <button class="logout" onclick="doLogout()">Logout</button></div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('paintings')">Paintings</button>
            <button class="tab" onclick="showTab('photography')">Photography</button>
            <button class="tab" onclick="showTab('settings')">Settings</button>
        </div>

        <div id="msg" class="msg hidden"></div>

        <div id="paintings" class="tab-content">
            <form id="painting-form" onsubmit="return saveWork(event,'painting')">
                <div class="field"><label>Image</label>
                    <div class="upload" id="painting-upload"><input type="file" accept="image/*" onchange="preview(this,'painting')"><span>Tap to upload</span></div>
                </div>
                <div class="field"><label>Title</label><input type="text" id="painting-title" required></div>
                <div class="field"><label>Year</label><input type="number" id="painting-year" value="2025"></div>
                <div class="field"><label>Medium</label><input type="text" id="painting-medium" value="Acrylic on canvas"></div>
                <div class="field"><label>Dimensions</label><input type="text" id="painting-dimensions" placeholder="60 × 80 cm"></div>
                <div class="field"><label>Price</label><input type="text" id="painting-price" placeholder="POA"></div>
                <div class="field"><label class="check"><input type="checkbox" id="painting-available" checked><span>Available</span></label></div>
                <button type="submit" class="btn submit" id="painting-btn">Add Painting</button>
            </form>
            <div class="list"><h3>Existing Works</h3><div id="painting-list"><div class="loading"></div></div></div>
        </div>

        <div id="photography" class="tab-content hidden">
            <p style="color:var(--muted);margin-bottom:1.5rem;font-size:.9rem">3-5 elevated photographs maximum.</p>
            <form id="photo-form" onsubmit="return saveWork(event,'photography')">
                <div class="field"><label>Image</label>
                    <div class="upload" id="photo-upload"><input type="file" accept="image/*" onchange="preview(this,'photo')"><span>Tap to upload</span></div>
                </div>
                <div class="field"><label>Title</label><input type="text" id="photo-title" required></div>
                <div class="field"><label>Year</label><input type="number" id="photo-year" value="2025"></div>
                <div class="field"><label>Medium</label><input type="text" id="photo-medium" value="Archival pigment print"></div>
                <div class="field"><label>Dimensions</label><input type="text" id="photo-dimensions" placeholder="40 × 30 cm"></div>
                <div class="field"><label>Edition</label><input type="text" id="photo-edition" placeholder="Edition of 5"></div>
                <div class="field"><label class="check"><input type="checkbox" id="photo-available" checked><span>Available</span></label></div>
                <button type="submit" class="btn submit" id="photo-btn">Add Photograph</button>
            </form>
            <div class="list"><h3>Existing Works</h3><div id="photo-list"><div class="loading"></div></div></div>
        </div>

        <div id="settings" class="tab-content hidden">
            <form onsubmit="return saveSymbol(event)">
                <div class="field"><label>Symbol</label>
                    <div class="upload" id="symbol-upload"><input type="file" accept="image/svg+xml,image/png" onchange="preview(this,'symbol')"><span>Upload SVG</span></div>
                </div>
                <button type="submit" class="btn submit">Update Symbol</button>
            </form>
            <div class="divider">
                <h3>GitHub</h3>
                <div class="field"><label>Repository</label><input type="text" id="cfg-repo" readonly></div>
                <button class="logout" onclick="resetConfig()">Reset Config</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script>
const AUTH0={domain:'dev-0or17tvlovkdkwt6.us.auth0.com',clientId:'Wawyj8DhMBc40evEU5tB6Q4dqmEjQ3i8',authorizationParams:{redirect_uri:location.origin+'/admin/index.html'}};
let auth0,user,cfg,img={painting:null,photo:null,symbol:null};

async function init(){
    auth0=await window.auth0.createAuth0Client(AUTH0);
    if(location.search.includes('code=')){await auth0.handleRedirectCallback();history.replaceState({},'','/admin/')}
    if(await auth0.isAuthenticated()){user=await auth0.getUser();route()}else{show('login')}
}

function route(){
    cfg=JSON.parse(localStorage.getItem('alchemy_cfg'));
    if(!cfg||!cfg.token){show('setup')}
    else{show('admin');document.getElementById('user').textContent=user.email;document.getElementById('cfg-repo').value=cfg.repo;loadAll()}
}

function show(id){['login','setup','admin'].forEach(x=>document.getElementById(x).classList.toggle('hidden',x!==id))}

async function doLogin(){await auth0.loginWithRedirect()}
async function doLogout(){await auth0.logout({logoutParams:{returnTo:location.origin}})}

function saveConfig(){
    const t=document.getElementById('gh-token').value.trim(),r=document.getElementById('gh-repo').value.trim();
    if(!t||!r)return alert('Fill both fields');
    cfg={token:t,repo:r};localStorage.setItem('alchemy_cfg',JSON.stringify(cfg));route();
}

function resetConfig(){if(confirm('Reset?')){localStorage.removeItem('alchemy_cfg');cfg=null;route()}}

function showTab(t){
    document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active',x.textContent.toLowerCase().includes(t)));
    document.querySelectorAll('.tab-content').forEach(x=>x.classList.add('hidden'));
    document.getElementById(t).classList.remove('hidden');
}

function preview(input,type){
    const f=input.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=e=>{
        const c=document.getElementById(type+'-upload');
        c.classList.add('has');
        c.innerHTML='<input type="file" accept="image/*" onchange="preview(this,\''+type+'\')"><img src="'+e.target.result+'">';
        img[type]={data:e.target.result.split(',')[1],type:f.type};
    };
    r.readAsDataURL(f);
}

async function gh(path,method,body){
    const res=await fetch('https://api.github.com/repos/'+cfg.repo+path,{
        method:method||'GET',
        headers:{Authorization:'token '+cfg.token,Accept:'application/vnd.github.v3+json','Content-Type':'application/json'},
        body:body?JSON.stringify(body):undefined
    });
    if(!res.ok&&res.status!==404)throw new Error('GitHub error');
    return res;
}

async function getFile(p){try{const r=await gh('/contents/'+p);return r.status===404?null:await r.json()}catch{return null}}

async function saveFile(p,content,msg){
    const e=await getFile(p);
    await gh('/contents/'+p,'PUT',{message:msg,content:btoa(unescape(encodeURIComponent(content))),sha:e?.sha,branch:'main'});
}

async function uploadImg(data,folder){
    const ext=data.type.split('/')[1]||'jpg',name=Date.now()+'.'+ext,path='images/'+folder+'/'+name;
    await gh('/contents/'+path,'PUT',{message:'Add '+name,content:data.data,branch:'main'});
    return '/'+path;
}

async function loadAll(){await loadList('paintings','painting-list');await loadList('photography','photo-list')}

async function loadList(folder,containerId){
    const c=document.getElementById(containerId);c.innerHTML='<div class="loading"></div>';
    try{
        const r=await gh('/contents/data/'+folder);
        if(r.status===404){c.innerHTML='<p style="color:var(--muted)">No works yet.</p>';return}
        const files=await r.json();
        if(!files.length){c.innerHTML='<p style="color:var(--muted)">No works yet.</p>';return}
        c.innerHTML='';
        for(const f of files){
            if(!f.name.endsWith('.json'))continue;
            const fr=await gh('/contents/data/'+folder+'/'+f.name),fd=await fr.json(),w=JSON.parse(atob(fd.content));
            c.innerHTML+=`<div class="item"><img src="${w.image}" onerror="this.style.background='var(--border)'"><div class="item-info"><div class="item-title">${w.title}</div><div class="item-meta">${w.year} · ${w.available?'Available':'Sold'}</div></div><button class="item-del" onclick="delWork('${folder}','${f.name}','${fd.sha}')">Delete</button></div>`;
        }
    }catch{c.innerHTML='<p style="color:var(--err)">Error loading.</p>'}
}

async function delWork(folder,file,sha){
    if(!confirm('Delete?'))return;
    try{await gh('/contents/data/'+folder+'/'+file,'DELETE',{message:'Delete',sha,branch:'main'});msg('Deleted','ok');loadAll()}
    catch{msg('Error','err')}
}

async function saveWork(e,type){
    e.preventDefault();
    const prefix=type==='painting'?'painting':'photo',folder=type==='painting'?'paintings':'photography';
    const btn=document.getElementById(prefix+'-btn');btn.disabled=true;btn.textContent='Saving...';
    try{
        if(!img[prefix])throw new Error('Upload image');
        const title=document.getElementById(prefix+'-title').value.trim();
        if(!title)throw new Error('Enter title');
        const id=title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
        const imgPath=await uploadImg(img[prefix],folder);
        const work={id,title,year:+document.getElementById(prefix+'-year').value,medium:document.getElementById(prefix+'-medium').value,dimensions:document.getElementById(prefix+'-dimensions').value,image:imgPath,available:document.getElementById(prefix+'-available').checked};
        if(type==='painting'){const p=document.getElementById('painting-price').value;if(p)work.price=p}
        if(type==='photography'){const ed=document.getElementById('photo-edition').value;if(ed)work.edition=ed}
        await saveFile('data/'+folder+'/'+id+'.json',JSON.stringify(work,null,2),'Add '+title);
        msg(title+' saved','ok');
        document.getElementById(prefix+'-form').reset();
        const u=document.getElementById(prefix+'-upload');u.classList.remove('has');u.innerHTML='<input type="file" accept="image/*" onchange="preview(this,\''+prefix+'\')"><span>Tap to upload</span>';
        img[prefix]=null;loadAll();
    }catch(err){msg(err.message||'Error','err')}
    btn.disabled=false;btn.textContent=type==='painting'?'Add Painting':'Add Photograph';
    return false;
}

async function saveSymbol(e){
    e.preventDefault();
    if(!img.symbol)return msg('Upload symbol','err');
    try{
        const ex=await getFile('images/symbol.svg');
        await gh('/contents/images/symbol.svg','PUT',{message:'Update symbol',content:img.symbol.data,sha:ex?.sha,branch:'main'});
        msg('Symbol updated','ok');img.symbol=null;
    }catch{msg('Error','err')}
    return false;
}

function msg(t,type){const m=document.getElementById('msg');m.textContent=t;m.className='msg '+type;setTimeout(()=>m.classList.add('hidden'),4000)}

init();
    </script>
</body>
</html>
